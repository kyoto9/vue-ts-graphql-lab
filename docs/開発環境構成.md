# 開発環境構成

## ねらい
- 新規メンバーが数分で全体像と起動手順を把握し、UI と GraphQL サーバーを同時に立ち上げられるようにします。
- 詳細なアーキテクチャは [フロー解説](フロー解説.md)、利用ライブラリの背景は [使用ツール](使用ツール.md) を参照してください。

## 技術スタック
### フロントエンド
- Vue 3 (Composition API) を用いた SPA。
- TypeScript + `vue-tsc` による型安全な SFC 構成。
- Vite 7 を開発サーバーとビルドに使用。
- Apollo Client 3 + `@vue/apollo-composable` で GraphQL 通信とキャッシュ管理を実装。

### バックエンド
- Node.js 20 系上で動作する Apollo Server 5 (standalone)。
- TypeScript を `tsx` でトランスパイルせず実行、`npm run build` 時に `tsc` を使用。
- Resolver はメモリ上の Todo ストアを更新する最小構成。

### 共通 / 開発支援
- npm 10 系をパッケージマネージャーとして利用し、`package-lock.json` でバージョンを固定。
- Docker Compose で client/server を同一ネットワーク内に配置。Node 20 ベースのコンテナを使用。
- Node 版 GraphQL DevTools、Apollo DevTools、VS Code (Volar / GraphQL 拡張) を推奨。

## 開発マシン前提
- Node.js 20.x / npm 10.x（Volta や nvm-windows で固定することを推奨）。
- Docker Desktop 4.x 以降（コンテナで試す場合）。
- Git と VS Code など任意のエディター。

## Docker 開発環境
- `compose.yaml` は Node 20 イメージを使用し、`client/` と `server/` をボリュームマウントします。
- `client-node_modules` / `server-node_modules` ボリュームで `node_modules` をコンテナ間で共有し、毎回のクリーンインストールを避けています。
- 起動: `docker compose up -d --build`
- 停止: `docker compose down`
- 再ビルド: `docker compose build --no-cache`
- `VITE_GRAPHQL_URL` はコンテナ内で `http://server:4000/graphql` に設定済みです。ローカル環境へ合わせる場合は `client/.env` で上書きしてください。

## 環境変数とポート
| 対象 | キー | 既定値 | 役割 |
| --- | --- | --- | --- |
| client | `VITE_GRAPHQL_URL` | `http://localhost:4000/graphql` | GraphQL の接続先 URL |
| client (Docker) | `CHOKIDAR_USEPOLLING` | `true` | Windows + ボリューム時のファイル監視安定化 |
| server | `PORT` | `4000` | 必要に応じて `startStandaloneServer` に渡す |
| 共通 | `NODE_ENV` | `development` | ビルドやロギングの切り替えに利用予定 |

`.env` / `.env.local` を追加する場合は `.env.example` に反映し、このドキュメントに追記してください。

## 主要依存バージョン
| パッケージ | バージョン | 備考 |
| --- | --- | --- |
| Node.js | 20.x | LTS。Volta / nvm-windows で固定を推奨 |
| npm | 10.x | lockfile を共有し、`npm install` を利用 |
| Vue | ^3.5.22 | Vite 7 系と互換 |
| Vite | ^7.1.7 | `npm run dev/build/preview` で利用 |
| TypeScript (client) | ~5.9.3 | `vue-tsc` で SFC の型チェック |
| TypeScript (server) | ^5.9.3 | `tsc` / `tsx` で使用 |
| @apollo/client | ^3.14.0 | フロントの GraphQL クライアント |
| @apollo/server | ^5.0.0 | BFF 実装 |
| graphql | ^16.11.0 | スキーマ定義の共通依存 |

## トラブルシューティング
- **ポート競合**: 4000 / 5173 が他プロセスで使用されている場合は停止するか、`.env` と `vite.config.ts` / `startStandaloneServer` の設定を変更してください。
- **CORS エラー**: Apollo Server 5 standalone はデフォルトで CORS 許可済みですが、別ホストからアクセスする際は `startStandaloneServer` の `cors` 設定を追記します。
- **型エラー**: `@/` などのパスエイリアス、GraphQL ドキュメントの import 名を確認し、`npm run build` で最終確認してください。
- **依存解決失敗 (`npm ci`)**: lockfile が存在しない場合はリポジトリから取得するか、`npm install` で再生成してコミットします。
- **サーバー URL 誤り**: UI から 4000 番に届かない場合は `client/src/lib/apollo.ts` と `.env` の URL を確認してください。
