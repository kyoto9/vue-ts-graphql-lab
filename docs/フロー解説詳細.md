# フロー解説詳細

## 1. ブラウザ読み込みから Vue 起動まで
1. ブラウザが `client/index.html` を取得し、`<div id="app"></div>` と `<script type="module" src="/src/main.ts"></script>` を読み込む。
2. Vite の開発サーバーまたはビルド済みバンドルが `client/src/main.ts` をブラウザへ配信し、`createApp(App)` で Vue アプリケーションを生成する。
3. `client/src/lib/apollo.ts` からエクスポートされる `apolloClient` を `DefaultApolloClient` として `app.provide` し、すべてのコンポーネントで GraphQL クライアントが利用可能になる。
4. `app.mount("#app")` により、`index.html` 内の `#app` 要素が `App.vue` のレンダリング対象となる。

## 2. `App.vue` の描画とリアクティビティ
- `<template>` ではフォームと Todo 一覧を定義しており、`ref` や `computed` で宣言したリアクティブ変数がバインドされる。
- `<script setup lang="ts">` 内で以下を行う:
  - `useQuery(GET_TODOS)` が初期レンダリング時に実行され、取得状態 (`loading`/`error`/`result`) を自動的に追跡する。
  - `computed(() => result.value?.todos ?? [])` で、未取得時も安全に扱える Todo 配列を作成する。
  - `useMutation` を 3 種類（追加・切替・削除）用意し、`mutate` 関数をボタン押下ハンドラで呼び出す。
  - `watchEffect` によりログへ取得状況を出力し、問題発生時の切り分けを容易にする。

## 3. Todo 取得フロー
1. `useQuery(GET_TODOS)` が Apollo Client を通じて `http://localhost:4000/` に Query リクエストを送信する。
2. `GET_TODOS` の定義は `client/src/graphql/queries.ts` にあり、`todos { id title done }` を要求する。
3. サーバーの `server/src/index.ts` で `Query.todos` リゾルバが呼び出され、メモリ上の `store` 配列を JSON として返却する。
4. Apollo Client がレスポンスをキャッシュに保存し、Vue が再描画してテンプレートの `v-for="t in todos"` が最新データを描画する。

## 4. Todo 追加フロー
1. 入力欄でタイトルを入力し「追加」ボタンを押下すると `onAdd()` が実行される。
2. `addTodo({ title })` が Mutation リクエストを送信し、`ADD_TODO`（`client/src/graphql/mutations.ts`）に従って新規 Todo を要求する。
3. サーバー側の `Mutation.addTodo` リゾルバが `store` に要素を追加し、追加された Todo を返す。
4. `useMutation` の `update` フックがキャッシュから `GET_TODOS` 結果を読み込み、新しい Todo を末尾に加えた配列を書き戻す。
5. キャッシュ更新により Vue のテンプレートが即座にリレンダリングされ、画面に新規 Todo が表示される。

## 5. Todo 状態切替フロー
1. 一覧の「切替」ボタン押下で `onToggle(id)` が実行され、`toggleTodo({ id })` が Mutation を送る。
2. サーバーの `Mutation.toggleTodo` が該当 ID を検索し、`done` を反転して返す。
3. クライアント側では `onDone` フックで `refetch()` を呼び、一覧を再取得して画面を更新する。

## 6. Todo 削除フロー
1. 「削除」ボタンで `onDelete(id)` が呼ばれ、`deleteTodo` Mutation を `optimisticResponse` 付きで送信する。
2. 楽観的レスポンスによりサーバー応答前に対象 Todo が一覧から除外される。
3. 実際のレスポンスが返ると `update` フックが `GET_TODOS` キャッシュをフィルタリングし、最終的な状態を同期する。

## 7. Apollo Server 側の処理概要
- `server/src/index.ts` にて `typeDefs` で Query/Mutation と `Todo` 型を定義。
- `resolvers` で `store` 配列を操作するロジックを実装。
- `startStandaloneServer` がポート 4000 で待ち受け、フロントエンドから届いた GraphQL リクエストを該当リゾルバへディスパッチする。
- レスポンスは JSON として返送され、ブラウザ側の Apollo Client がキャッシュとリアクティブな UI を更新する。

## 8. デバッグ・トレース
- `console.log` が `main.ts` と `App.vue` に挿入されており、「真っ白」など描画トラブル時にロード順序や通信結果を追跡できる。
- `watchEffect` のログで Query の成否と取得データが逐次表示され、ネットワーク・サーバー・キャッシュのどこで問題が起きているか切り分けやすい。
